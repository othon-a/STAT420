---
title: "STAT 420 Project - Crop Yield"
author: "Ziquan Wang and Othon Almanza"
date: "2025-10-29"
output: pdf_document
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)

suppressPackageStartupMessages({
library(readr)
library(lmtest)
library(MASS)
library(faraway)
library(tidyverse)
library(glmnet)
})

df = read_csv("cleaned_yield_with_gdp_cat.csv")
df_potatoes = subset(df, crop == "Potatoes")
df_potatoes = df_potatoes[, -(1:2)]
```

```{r echo=FALSE}
diagnostic_plots = function(model) {
  
  # 2x2 layout
  par(mfrow = c(2, 2))
  
  fit = fitted(model)
  res = residuals(model)
  
  plot(fit, res,
       xlab = "Fitted values",
       ylab = "Residuals",
       main = "Fitted vs Residuals")
  abline(h = 0, lty = 2, col = "red")
  
  hist(res,
       breaks = 15,
       main = "Histogram of Residuals",
       xlab = "Residuals")
  
  qqnorm(res,
         main = "Normal Q-Q Plot")
  qqline(res, col = "red")
  
  b = boxcox(
    model,
    lambda = seq(-2, 2, 0.1),
    plotit = TRUE
  )
  
}

diagnostic_tests = function(model) {
  
  # Basic quantities
  res = residuals(model)
  n = length(res)
  p = length(coef(model))  
  
  bp = bptest(model)
  
  shapiro = shapiro.test(res)
  
  vif_values = car::vif(model)
  cat("=== Breusch-Pagan Test (Homoscedasticity) ===\n")
  print(bp)
  cat("Interpretation: p-value < 0.05 suggests heteroscedasticity.\n\n\n")
  
  cat("=== Shapiro-Wilk Test (Normality of Residuals) ===\n")
  print(shapiro)
  cat("Interpretation: p-value < 0.05 suggests non-normal residuals.\n\n\n")
  
  cat("=== Variance Inflation Factor (VIF) ===\n\n")
  print(vif_values)
  cat("\nInterpretation: VIF > 5 suggests moderate collinearity; VIF > 10 suggests high multicollinearity.")
}

loocv = function(model) {
  loocv_rmse = c(
    RMSE = sqrt(mean(residuals(model)^2)),
    LOOCV_RMSE = sqrt(mean((resid(model)/(1 - hatvalues(model)))^2))
  )
  
  cat("=== LOOCV-RMSE ===\n\n")
  print(loocv_rmse)
  cat("\nInterpretation: LOOCV-RMSE significantly larger than RMSE may indicate under or over-fitting")
}

boxcox_lambda = function(model) {
  bxcx = boxcox(model)
  lambda = c("Box-Cox Lambda" = bxcx$x[which.max(bxcx$y)])
  print(lambda)
}
```

## Introduction

Crop yield prediction is an important aspect of agricultural planning that has received greater interest with the advent of machine learning. Using a dataset of crop yields, we analyzed numeric and categorical predictors to uncover patterns that correlate with yield mass. The insight gained from a crop yield analysis can be beneficial in numerous way: It can assist in optimizing farming techniques to maximize crop output. It can also be used to predict crop yields within given conditions, assist in site suitability assessments, and prepare for long-term changes in climate patterns.

Our dataset was acquired from Kaggle and was originally compiled form the Food and Agriculture Organization and the World Bank. Each observation represents a crop yield measured in hectograms per hectare (hg/ha), with accompanying data including the type of crop, country of production, average rainfall, pesticide tonnes, and average temperature.

## Methods

### Data Cleaning

The first step in cleaning the dataset was to remove an index column and identify duplicate observations. Duplicates were found in the dataset and removed. Further, there were duplicates in the data with different temperature values but identical values for all other fields. These instances were each aggregated into a single observation containing the average temperature for the duplicate records. Observations with null values were also removed. Curiously, no data for the year 2003 was provided.

Additional datasets were identified and joined with the core data to supplement the analysis. Country-level gross domestic product (GDP) data was acquired from the World Bank since economic well-being could conceivably improve farming practices and efficiency. Countries were divided into low, middle, and high-income countries using quantile breaks to analyze as a categorical predictor. Additionally, we were concerned about the high granularity of countries as a predictor. To enhance the interpretability of other predictors, we instead categorized countries into subregions by joining this category from a United Nations geoscheme dataset. For the GDP and subregions joins, a few country names had to be manually renamed to match the core dataset (e.g. renaming 'The Bahamas' to 'Bahamas').

Finally, we decided to focus on a single crop for our analysis since different crops are affected differently by the predictors we analyzed. Potatoes had the highest number of observations in our dataset. As a staple in much of the world, it also had the highest geographic distribution. Our final steps in data cleaning involved narrowing the working data to the potato subset, removing the unused country and crop columns, and renaming the remaining columns for usability. The final output was written into its own .csv file.

<!-- Removed index to find duplicates -->
<!-- Averaged the temperature -->
<!-- Remove NA ,No NA in the data set -->
<!-- renamed the predictors for easy coding -->

<!-- Transform countries to new cat predictors: -->
<!--   Using world bank data https://data.worldbank.org/indicator/NY.GDP.PCAP.CD to allocate GPD tiers to coutries using 2002 center year GPD data, -->
<!--     addressed name mismatch issues. -->
<!--   divide coutries into subregions -->

<!-- Different crops are affected differently by these predictor, we decided ton focus on the one has most data Potato -->

### Exploratory Data Analysis

Our first step in data exploration involved using cor() and pairs() to identify any trends and obvious collinearity issues (see appendix). Right away, we found patterns emerging. A strong correlation is seen between GDP and yield, indicating that economic prosperity likely does affect crop output positively. A strong inverse correlation was found between temperature and GDP, illustrating known differences in economic development between the Global North and the Global South. We also see crop yields trending upward over the years, likely due to advances in technology and farming techniques.

```{r echo=FALSE}
par(mfrow = c(2, 2))
gdp_tier_ordered = factor(df_potatoes$gdp_tier, levels = c("Low", "Middle", "High"))
boxplot(df_potatoes$yield_hg_ha ~ gdp_tier_ordered,
        main = "Crop Yield vs Gross Demostic Product",
        xlab = "Gross Domestic Product",
        ylab = "Crop Yield (hg/ha)")

boxplot(df_potatoes$temp_c ~ gdp_tier_ordered,
        main = "Temperature vs Gross Domestic Product",
        xlab = "Gross Domestic Product",
        ylab = "Temperature (in Â°C)")

boxplot(df_potatoes$yield_hg_ha ~ df_potatoes$year,
        main = "Crop Yield vs Year",
        xlab = "Year",
        ylab = "Crop Yield (hg/ha)")
par(mfrow = c(1, 1))
```

Additionally, pairs() uncovered a pattern between pesticides and yield output that might benefit from one or more predictor-level transformations. Temperature might also benefit from a transformation.

```{r echo=FALSE}
par(mfrow = c(1, 2))
plot(df_potatoes$yield_hg_ha ~ df_potatoes$pesticides_t,
     main = "Yield vs Pesticides",
     xlab = "Pesticides (in Tonnes)",
     ylab = "Yield (hg/ha)")
plot1 = lm(df_potatoes$yield_hg_ha ~ df_potatoes$pesticides_t)

plot(df_potatoes$yield_hg_ha ~ df_potatoes$temp_c,
     main = "Yield vs Temperature",
     xlab = "Temperature (in Degrees Celsius)",
     ylab = "Yield (hg/ha)")
plot1 = lm(df_potatoes$yield_hg_ha ~ df_potatoes$pesticides_t)
par(mfrow = c(1, 1))
```



# Full Linear Model

After exploring the cleaned data, we created a full additive model using yield as a function of the remaining predictors. This achieved a baseline adjusted r-squared of 0.701. The summary output is shown below.

```{r echo=FALSE}
add_model = lm(yield_hg_ha ~ ., data = df_potatoes)
summary(add_model)
```
With an r-squared of 0.7046, our baseline model shows a strong correlation between our predictors and the yield response. This coefficient of determination indicates that 70.46% of the observed variation in yield can be explained by the full additive linear model.

We can also see patterns emerge from the model's coefficients. First, we observe that year is positively correlated with crop yield. When all other predictors are equal, each additional year results in a yield increase of 2,300 hg/ha. We see that rain has a small but positive correlation with crop yield, with an increase of 7.9 hg/ha for every additional millimeter of rainfall. Pesticides are also correlated with increased crop yield, with an increase in 0.6 hg/ha for each additional tonne of pesticides. Temperature reverses these trends, with yield decreases of 2,200 hg/ha for every increase in degrees Celsius, illustrating potatoe's suitability for cooler climates. The GDP tiers reinforce what we had seen during the data exploration process: The base factor level of high-GDP corresponds with the highest corp yields. The intercept is reduced for middle-GDP observations and reduced even further for low-GDP observations. When we look at the subregion factor, we see that are small but statistically significant variations among the different subregions. The notable exception to this is Western Europe, which has a high p-value of 0.269. This may be due to the inclusion of an Eastern Europe subregion, which likely shares many commonalities with Western Europe regarding climate conditions, economic output, and farming practices.

<!-- Add diagnostic visualizations -->

We can further validate the full model using leave-one-Out cross-validation (LOOCV). Using hat values to conduct LOOCV, we attain a root mean square error (RMSE) of 73,268.77 hg/ha. This is only slightly larger than the RMSE of the full additive model, 73,154.80 hg/ha, indicating a favorable result. The LOOCV RMSE is necessarily larger than the model's RMSE, but in this case only slightly so.

# Other Methods

We also created a null model that omitted the subregions predictor to evaluate whether it was needed in our final model. This model resulted in a significantly lower adjusted r-squared of 0.464. An ANOVA test confirmed this trend. Using any reasonable significance level resulted in an outcome that rejects the null hypothesis in favor of including subregions. Including subregions was thus taken as a good compromise to build a stronger model without needing to classify crop yields at the country level.

Having identified pesticides as a predictor that might benefit from a transformation, we first observe that log transforming pesticides seems to improve its relationship with yield size. The relationship is further improved after squaring the log transformation.

```{r echo=FALSE}
par(mfrow = c(2, 2))
plot(df_potatoes$yield_hg_ha ~ df_potatoes$pesticides_t,
     main = "Yield vs Pesticides",
     xlab = "Pesticides (in Tonnes)",
     ylab = "Yield (hg/ha)")
plot1 = lm(df_potatoes$yield_hg_ha ~ df_potatoes$pesticides_t)
abline(plot1, col = "red")

plot(df_potatoes$yield_hg_ha ~ I(log(df_potatoes$pesticides_t)),
     main = "Yield vs Log Pesticides",
     xlab = "log(pesticides_t)",
     ylab = "Yield (hg/ha)")
plot2 = lm(df_potatoes$yield_hg_ha ~ I(log(df_potatoes$pesticides_t)))
abline(plot2, col = "red")

plot(df_potatoes$yield_hg_ha ~ I(log(df_potatoes$pesticides_t)^2),
     main = "Yield vs Log Pesticides Squared",
     xlab = "I(log(pesticides_t)^2)",
     ylab = "Yield (hg/ha)")
plot3 = lm(df_potatoes$yield_hg_ha ~ I(log(df_potatoes$pesticides_t)^2))
abline(plot3, col = "red")
par(mfrow = c(1, 1))
```

A quadratic transformation was applied to temperature (see appendix).

We created an additive model that left subregion as a predictor and also incorporated predictor-level transformations for pesticides and temperature. We attempted a backward BIC search to see if the model could be reduced from here, but perhaps unsurprisingly, no predictors were dropped.

Having chosen the predictor transformations to incorporate, we then created a model that created two-way interactions among rain, pesticides, temperature, and GDP. Year and region were left in the model but not considered for two-way interactions. This created a large model appropriate for BIC backward search. The search was successful, and the model was reduced to a manageable size. The model returns an RMSE of 48,705.68 hg/ha and a LOOCV-RMSE of 49,403.77 hg/ha, an improvement from the full additive model. Additionally, variance inflation factors (VIF's) do not show problematic covariance within the model.

Finally, we used boxcox() to find an appropriate Box-Cox transformation on the response. A lambda value of 0.707 was identified and used.

<!-- Pair exploring data trends -->

<!-- Cov to see data covariance -->


<!-- Full linear model (r^2 adj 0.701) -->

<!-- Explain Full model -->

<!-- Full model vs Full model - subregions anova shows subregions significant -->

<!-- Predictor and Response Transformation before and after R^2 adj gain  0.7288  -->
<!--     Response ~ solo predictor -->
<!--     Boxcox : response is likely a complex combination of different  -->

<!-- Full model with transformation - using backwards selection, no reduction -->

<!-- Testing interaction further  -->

<!--   reduction with BIC backwards R^2 adj gain 0.7458  -->
<!--   reduction with LASSO regression -->

<!-- Resulting 3 models -->

<!--   reduction with BIC backwards R^2 adj gain 0.7458  -->
<!--   reduction with LASSO regression -->
<!--   add yours and how you wanted to name it -->

### Conlusion

Our final model achieves an r-squared of 0.7477, accounting for a larger portion of the response's observed variation compared to the full additive model's r-squared of 0.7046. We see improvements in other diagnostics as well: The model's RMSE is improved from 73,154.80 to 48,705.68. It also shows a favorable LOOCV-RMSE of 49,403.77. Additionally, normality is considerably increased in the final model from a Shapiro-Wilk normality p-value of 0.003364 to a p-value of 0.0209. We believe the updated model is a stronger model prediction, as well as a sounder model for explanation.

<!-- using standard function to analyzie and their interpretation -->


### Appendix

```{r}
df_potatoes_num = df_potatoes%>%        
  mutate(
    gdp_tier = as.numeric(factor(gdp_tier, levels = c("Low", "Middle", "High"))),     
    subregion = as.numeric(factor(subregion))    
  )

round(cor(df_potatoes_num), 2)
```

```{r}
pairs(df_potatoes_num)
```

```{r}
add_model = lm(yield_hg_ha ~ ., data = df_potatoes)
diagnostic_plots(add_model)
```

```{r}
diagnostic_tests(add_model)
```

```{r}
loocv(add_model)
```

```{r}
add_nosubreg = lm(yield_hg_ha ~ . - subregion, data = df_potatoes)
anova(add_nosubreg, add_model)
```

```{r}
par(mfrow = c(2, 2))
plot(df_potatoes$yield_hg_ha ~ df_potatoes$temp_c,
     main = "Yield vs Temperature",
     xlab = "Temperature (in Tonnes)",
     ylab = "Yield (hg/ha)")
temp1 = lm(df_potatoes$yield_hg_ha ~ df_potatoes$temp_c)
abline(temp1, col = "red")

plot(df_potatoes$yield_hg_ha ~ I(df_potatoes$temp_c^2),
     main = "Yield vs Temperature",
     xlab = "I(temp_c^2)",
     ylab = "Yield (hg/ha)")
temp2 = lm(df_potatoes$yield_hg_ha ~ I(df_potatoes$temp_c^2))
abline(temp2, col = "red")
par(mfrow = c(1, 1))
```

```{r}
tran_model = lm(yield_hg_ha ~ year + rain_mm + I((log(pesticides_t))^2) + I(temp_c^2) + gdp_tier +subregion, data = df_potatoes)

step(tran_model, direction = "backward", k=log(length(resid(tran_model))), trace = 0)
```

```{r}
int_model = lm(yield_hg_ha ~ year + (rain_mm + I((log(pesticides_t))^2) + I(temp_c^2) + gdp_tier)^2 +subregion , data = df_potatoes)

(bic_model = step(int_model, direction = "backward", k=log(length(resid(int_model))), trace = 0))

car::vif(bic_model)
```

```{r}
loocv(bic_model)
```

```{r}
boxcox_lambda(bic_model)
```

```{r}
final_model = lm(yield_hg_ha^.707 ~ year + rain_mm + I((log(pesticides_t))^2) + I(temp_c^2) + 
                   gdp_tier + subregion + rain_mm:I((log(pesticides_t))^2) + 
                   rain_mm:gdp_tier + I((log(pesticides_t))^2):I(temp_c^2) + 
                   I((log(pesticides_t))^2):gdp_tier, data = df_potatoes)

summary(final_model)
```

```{r}
diagnostic_plots(final_model)
```

```{r}
diagnostic_tests(final_model)
```

